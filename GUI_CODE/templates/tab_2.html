<div>
  <div style="float:left;width:60%" id="leftSide">
    <h2 style="margin:1%">SELECT FROM ALL MGF FILES IN FOLDER</h2>

    <div class="input-group" style="margin: 1%">
      <span class="input-group-addon" id="basic-addon1">Operation to perform</span>
      <select class='form-control' id="mgf_operation_to_perform">
        <option value="extract_and_select">Extract reporter ion intensities AND select viable runs</option>
        <option value="only_extract">Only Extract reporter ion intensities</option>
      </select>
    </div>

    <div id="form_elements_if_extract_and_select">
      <div class="input-group" style="margin: 1%">
        <span class="input-group-addon" id="basic-addon1">FULL PATH to MGF DIRECTORY</span>
        <input type="text" class="form-control" id="mgfReadDirPath">
      </div>
      <div class="input-group" style="margin: 1%">
        <span class="input-group-addon" id="basic-addon1">&nbspmz_error (ppm, integer) &nbsp</span>
        <input type="number" onkeypress='return event.charCode >= 48 && event.charCode <= 57' class="form-control" id="mz_error">
      </div>
      <div class="input-group" style="margin: 1%">
        <span class="input-group-addon" id="basic-addon1">REPORTER ION TYPE</span>
        <select class='form-control' id="reporter_ion_type">
          {% if inverse_files %}
            {% for f in inverse_files %}
              <option value={{f.rpartition('-inv.txt')[0]}}>{{f.rpartition('-inv.txt')[0]}}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
      <div class="input-group" style="margin: 1%">
        <span class="input-group-addon" id="basic-addon1">Minimum Intensity per reporter</span>
        <input type="text" class="form-control" id="min_intensity">
      </div>
      <div class="input-group" style="margin: 1%">
        <span class="input-group-addon" id="basic-addon1">Minimum Reporters with said intensity</span>
        <input type="text" class="form-control" id="min_reporters">
      </div>
    </div>

    <div id="form_elements_if_only_extract" style="display: none">
      <div class="input-group" style="margin: 1%">
        <span class="input-group-addon" id="basic-addon1">SAMPLE THING</span>
        <input type="number" onkeypress='return event.charCode >= 48 && event.charCode <= 57' class="form-control" id="sample_thing">
      </div>
    </div>
    <br>
    <div class="input-group" style="margin: 1%">
      <span class="input-group-addon" id="basic-addon1">Perform largest-reporter recalibration</span>
      <select class='form-control' id="perform_recalibration">
        <option value="perform_recalibration">Perform recalibration</option>
        <option value="do_not_perform_recalibration">Do Not Perform recalibration</option>
      </select>
    </div>

    <div id="options_if_recalibrating">
      <div class="input-group" style="margin: 1%">
        <span class="input-group-addon" id="basic-addon1">&nbsp m/z error for recalibration  (ppm, integer, must be smaller than initial m/z error) &nbsp</span>
        <input type="number" onkeypress='return event.charCode >= 48 && event.charCode <= 57' class="form-control" id="recalibration_mz_error">
      </div>      
    </div>
    <div id="options_if_not_recalibrating" style="display: none">
    </div>


    <br>
    <button id="tab_2_button" class="btn btn-primary">Click to submit Tab 1</button>
  </div>
  <div style="float:right;width:30%;height:88vh;border-style:solid;border-width:5px;overflow:scroll;padding:10px" id="rightSide">
    <h1>Progress</h1>
    <ul>
    </ul>
  </div>
  <script>
  $("#mgf_operation_to_perform").change(function(e){
    console.log("Yo");
    console.log(e.target.value);
    var value = e.target.value;
    if (value == 'only_extract'){
      console.log("value is only_extract");
      $("#form_elements_if_only_extract").show();
      $("#form_elements_if_extract_and_select").hide();
    }
    else if (value == 'extract_and_select'){
      console.log("value is extract_and_select");
      $("#form_elements_if_only_extract").hide();
      $("#form_elements_if_extract_and_select").show();
    }
    else{
      alert("Something is funky, ask sam whats up");
    }
  });
  </script>
  <script>
  $("#perform_recalibration").change(function(e){
    console.log("Yippie");
    console.log(e.target.value);
    var value = e.target.value;
    if (value == 'perform_recalibration'){
      console.log("value is perform_recalibration");
      $("#options_if_recalibrating").show();
      $("#options_if_not_recalibrating").hide();
    }
    else if (value == 'do_not_perform_recalibration'){
      console.log("value is do_not_perform_recalibration");
      $("#options_if_recalibrating").hide();
      $("#options_if_not_recalibrating").show();
    }
    else{
      alert("Something is funky, ask sam whats up");
    }
  });
  </script>

  <script>
  $('#tab_2_button').click(function(e){
    console.log("clicked");
    $(this).attr('disabled', true);
    var that = $(this);
    var leftSide = that.parent();
    var mgfReadDirPath = leftSide.find("#mgfReadDirPath").first().val().trim();
    // var mgfWriteDirPath = leftSide.find("#mgfWriteDirPath").first().val().trim();
    var mzError = leftSide.find("#mz_error").first().val().trim();
    var reporterType = leftSide.find("#reporter_ion_type").first().val().trim();
    var minReporters = leftSide.find("#min_reporters").first().val().trim();
    var minIntensity = leftSide.find("#min_intensity").first().val().trim();
    var mgfOperationToPerform = leftSide.find("#mgf_operation_to_perform").first().val().trim();
    var performRecalibration = leftSide.find("#perform_recalibration").first().val().trim();
    var recalibrationMzError = leftSide.find('#recalibration_mz_error').first().val().trim();

    var shouldPerformMGFSelection = (mgfOperationToPerform == 'extract_and_select') ? 1 : 0;
    console.log("should perform selection: " + shouldPerformMGFSelection);
    var shouldRecalibrate = (performRecalibration == 'perform_recalibration') ? 1 : 0;
    console.log("should recalibrate: " + shouldRecalibrate);

    console.log(mgfReadDirPath);
    // console.log(mgfWriteDirPath);
    var rightSide = $(this).parent().siblings("#rightSide").first()
    rightSide.append("<div>Executing Function Now</div>")
    var startTime = new Date();
    async.waterfall([
      function(callback){
        console.log("inside of first waterfaller");
        $.ajax({
          type : "POST",
          url : "getMGFFiles",
          data: {mgfReadDirPath : mgfReadDirPath},
          success : function(result){
            console.log('success');
            console.log(result);
            // $(this).attr('disabled', false);
            return callback(null, result)
          },
          error: function(response, textStatus, HTTPError){
            callback({err : "ERROR IN PASSING BACK FILE NAMES"});
            if (textStatus){
              console.log(response);
              return alert("textStatus: " + textStatus);
            }
            if (HTTPError){
              console.log(response);
              return alert("HTTPError: " + HTTPError);
            }
          }
        })
      },
      function(fileArray, callback){
        if (!fileArray){
          return callback("No fileArray");
        }
        if (typeof fileArray == 'string'){
          console.log("FileArray needs to be parsed");
          fileArray = JSON.parse(fileArray);
        }
        if (!fileArray.length){
          rightSide.append("<div>NO FILES TO WRITE!</div>")
          return callback({err : "NO FILES TO WRITE"})
        }
        async.each(fileArray, function(elem, next){
          // var mgfReadPath = mgfReadDirPath + elem;
          // var mgfWritePath = mgfWriteDirPath + elem;
          // console.log(mgfReadPath);
          // return next(null);
          var data = {
            mgfReadDirPath : mgfReadDirPath,
            // mgfWriteDirPath : mgfWriteDirPath,
            mgfFileName : elem,
            mzError : mzError,
            reporterType : reporterType,
            minReporters : minReporters,
            minIntensity : minIntensity,
            shouldPerformMGFSelection : shouldPerformMGFSelection,
            shouldRecalibrate : shouldRecalibrate,
            recalibrationMzError : recalibrationMzError
          }
          console.log("Parsing file");
          rightSide.append("<div>Began selecting from file " + elem + "</div>");

          $.ajax({
            type:"POST",
            url:"tab_2_helper_function",
            data : data,
            // dataType : 'json',
            // contentType: "application/json",
            success : function(result){
              console.log(result);
              rightSide.append("<div>Finished Selecting from file " + elem + "</div>");
              // that.attr('disabled',false);
              return next(null)
              // alert("Completed Successfully");
            },
            error: function(response, textStatus, HTTPError){
              var responseText = (response && response.responseText) ?
                response.responseText : "ERROR IN EACHSERIES";
                rightSide.append('<div style="color:red">' + responseText + '</div>')
              return next(responseText);
            }
          });
        }, function(err){
          callback(err);
        })
      }/*,
      function(callback){
        $.ajax({
          type:"POST",
          url:"combine_mgf_files",
          data : {mgfWriteDirPath : mgfWriteDirPath},
          success : function(result){
            console.log(result);
            rightSide.append("<div>MERGED MGF FILES</div>");
            var difference = new Date() - startTime;
            rightSide.append("<div>MILLISECONDS TAKEN: " + difference + " <div>")
            return callback(null);
          },
          error: function(something, textStatus, HTTPError){
            return callback("ERROR IN combine_mgf_files");
          }
        });
      },
      function(callback){
        $.ajax({
          type:"POST",
          url:"combine_mgf_txt_files",
          data : {mgfWriteDirPath : mgfWriteDirPath},
          success : function(result){
            console.log(result);
            rightSide.append("<div>MERGED MGF.TXT FILES</div>");
            return callback(null);
          },
          error: function(something, textStatus, HTTPError){
            return callback("ERROR IN combine_mgf_files");
          }
        });
      }*/
    ],
    function(err, result){
      // if (err){console.log(err)}
      // if(result){console.log(result)}
      console.log("in final waterfall catcher");
      if (err && err.err && err.err == "NO FILES TO WRITE"){return;}
      console.log(err);
      if (err){
        alert(err)
      }
      var difference = new Date() - startTime;
      rightSide.append("<div>MILLISECONDS TAKEN: " + difference + " <div>")
      that.attr('disabled',false);
    })
  });
  </script>
</div>